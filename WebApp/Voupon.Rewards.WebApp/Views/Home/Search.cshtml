@model Voupon.Rewards.WebApp.Services.Home.Models.UserPrefrencesModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = Model.SearchText;
}
<style>
    span.empty-span:empty:before {
  content: "200b"; // unicode zero width space character
}

</style>
<div class="row categories">
    <div id="category" class="col-lg-2"></div>
    <div class="item-type-filter col-lg-10 px-0" id="productCategoryFilter" style="width: 100%; text-align: center ">
        <a class="prod-type-btn selectedProductType" data-type-id="1" data-type-name="Women's Fashion">
            <div class="img-container">
                <img src="/images/women-fashion-img.webp" class="lazyload" />
            </div>
            <span>Women's Fashion</span>
        </a>
        <a class="prod-type-btn selectedProductType" data-type-id="2" data-type-name="Men's Fashion">
            <div class="img-container">
                <img src="/images/men-fashion-img.webp" class="lazyload" />
            </div>
            <span>Men's Fashion</span>
        </a>
        <a class="prod-type-btn selectedProductType" data-type-id="6" data-type-name="Beauty, Health and Groceries">
            <div class="img-container">
                <img src="/images/grocery-img.webp" class="lazyload" />
            </div>
            <span>Beauty, Health & Groceries</span>
        </a>
        <a class="prod-type-btn selectedProductType" data-type-id="3" data-type-name="Gadgets and Accessories">
            <div class="img-container">
                <img src="/images/gadget-img.webp" class="lazyload" />
            </div>
            <span>
                Gadgets & Accessories
            </span>
        </a>
        <a class="prod-type-btn selectedProductType" data-type-id="4" data-type-name="Home and Family">
            <div class="img-container">
                <img src="/images/home-family-img.webp" class="lazyload" />
            </div>
            <span>Home & Family</span>
        </a>
        <a class="prod-type-btn selectedProductType" data-type-id="5" data-type-name="Leisure and Entertainment">
            <div class="img-container">
                <img src="/images/leisure-img.webp" class="lazyload" />
            </div>
            <span>Leisure & Entertainment</span>
        </a>
        <a class="prod-type-btn selectedProductType" data-type-id="7" data-type-name="Sports and Outdoor">
            <div class="img-container">
                <img src="/images/sports-img.webp" class="lazyload" />
            </div>
            <span>Sports & Outdoor</span>
        </a>
        <a class="prod-type-btn selectedProductType" data-type-id="8" data-type-name="Vouchers and Others">
            <div class="img-container">
                <img src="/images/vouchers-img.webp" class="lazyload" />
            </div>
            <span>Vouchers and Others</span>
        </a>
    </div>
</div>

<div class="row category-title-div">
    <div class="col-2">
    </div>
    <div class="col-10">
        <h1 class="category-title"></h1>
    </div>
</div>
<div class="row products-row">
    <div class="row col-12 category-products-row">
        <div class="col-lg-2 px-0">
            <div class="product-filter">
                <div class="product-filter-title">
                    <h4>SEARCH FILTER</h4>
                    <div loading="lazy" class="close-btn-img" onclick="closeHamburgerFunction()"></div>
                </div>
                <div class="product-sidebar mt-2 subCategory-filter" style="background-color:white;">
                    <div class="product-sidebar-widget">
                        <h4 class="hot-categories-title">Category Filter <i class="fas fa-angle-down" data-toggle="collapse" href="#productSubategoryFilter" aria-expanded="true"></i></h4>
                    </div>
                    <div class="product-sidebar-widget collapse show" id="productSubategoryFilter">
                    </div>
                </div>

                <div class="product-sidebar mt-2 price-filter" style="background-color:white;">
                    <div class="product-sidebar-widget">
                        <h4 class="hot-categories-title">Price Filter <i class="fas fa-angle-down d-none" data-toggle="collapse" href="#productPriceFilter" aria-expanded="true"></i></h4>
                    </div>
                    <div class="row price-filter-range" style="max-width: 330px;">
                        <div class="col-4 p-0">
                            <div class="mb-1">
                                <b>From</b>
                            </div>
                            <input class="form-control" id="priceMin" placeholder="Min" value="0" />
                        </div>
                        <div class="col-4 d-flex align-items-center p-0 mt-4 price-filter-line">
                            <hr class="w-100">
                        </div>
                        <div class="col-4 p-0">
                            <div class="mb-1">
                                <b>To</b>
                            </div>
                            <input class="form-control" id="priceMax" placeholder="Max" />
                        </div>
                    </div>
                </div>

                <div class="product-sidebar mt-2 location-filter" style="background-color:white;">
                    <div class="product-sidebar-widget">
                        <h4 class="hot-categories-title">Location Filter <i class="fas fa-angle-down d-none" data-toggle="collapse" href="#productLocationFilter" aria-expanded="true"></i></h4>
                    </div>
                    <div class="product-sidebar-widget row collapse show" id="productLocationFilter">
                        <h4 class="product-sidebar-widget-title"></h4>
                        <div class="grey-box locationFilter" id="location-cat-1" data-id="20">
                            Local
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-2" data-id="19">
                            Overseas
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-3" data-id="18">
                            West Malaysia
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-4" data-id="17">
                            East Malaysia
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-5" data-id="12">
                            Selangor
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-6" data-id="14">
                            Kuala Lumpur
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-7" data-id="7">
                            Penang
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-8" data-id="1">
                            Johor
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-9" data-id="2">
                            Kedah
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-10" data-id="8">
                            Perak
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-11" data-id="4">
                            Melaka
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-12" data-id="6">
                            Pahang
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-13" data-id="5">
                            Negeri Sembilan
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-14" data-id="13">
                            Terengganu
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-15" data-id="11">
                            Sarawak
                        </div>
                        <div class="grey-box locationFilter" d="location-cat-18" data-id="10">
                            Sabah
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-16" data-id="3">
                            Kelantan
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-17" data-id="9">
                            Perlis
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-19" data-id="16">
                            Putrajaya
                        </div>
                        <div class="grey-box locationFilter" id="location-cat-20" data-id="15">
                            Labuan
                        </div>
                    </div>
                </div>

                <div class="mt-3" style="max-width: 320px;">
                    <button type="button" onclick="onPriceFilterApply()" class="btn btn-block apply-button btn-secondary">Apply</button>
                </div>

                <div class="product-sidebar mt-2" style="background-color:white;">
                    <div class="mt-3" style="max-width: 320px;">
                        <a onclick="shopMenu()" class="category-menu-btn">Search Other Categories</a>
                    </div>
                </div>

            </div>
        </div>
        <div class="col-lg-10 px-0">
            <div class="col-12 category-title-div-sm">
                <h2 class="category-title">Searching...</h2>
            </div>

            <div id="productList">
            </div>
            <p id="loadingMessage" style="display: flex; flex-wrap: wrap; justify-content: center"><span style="font-size: 20px; margin-top: 25px; color: #999;">Loading...</span></p>
            <div class="col-lg-12 text-center"><button type="button" id="btnLoadMore" class="btn btn-primary btn-load-items" style="margin:20px auto 0;text-align:center;font-size:16px;"><span class="i18next" data-i18n="common.load-more">Load more</span></button></div>
            <div class="col-lg-12 text-center"><span class="i18next" id="btnNoMore" data-i18n="common.no-more" style="margin:20px 0 auto;text-align:center;font-size:16px;display:none;color: #bdbdbd;">You have reached the end.<br> Do a search to keep exploring!</span></div>

            <div id="noProduct" style="display:none;">
                <div class="col-lg-12">
                    <div class="text-center">
                        <h1><span class="fas fa-gift fa-4x"></span></h1>
                        <h2 style="margin-bottom:0;">No product found</h2>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<div id="productTemplate" style="display:none;">
    <div class="listItem">
        <div class="ibox">
            <div class="ibox-content product-box">
                <a href="/Product/Detail/74" class="product-link">
                    <div class="product-imitation">
                        <img class="product-img lazyload">
                    </div>
                    <div class="product-discount" style="display:none;">
                        <span class="badge badge-danger">15 % OFF</span>
                    </div>                    <div class="product-desc">
                        <div class="merchant-dealtype-div">
                            <div class="merchant-name"></div>
                        </div>
                        <h4 class="product-name">Aeon RM10 Cash Voucher</h4>
                    </div>
                    <p class="product-price">70 VPoints</p>
                    <div class="product-metabox">
                        <div>
                            <span class="outlet-location"></span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <p class="rating-box">
                                <span class="fas fa-star checked"></span>
                                <span class="fas fa-star checked"></span>
                                <span class="fas fa-star checked"></span>
                                <span class="fas fa-star checked"></span>
                                <span class="fas fa-star checked"></span>
                                <span class="product-rating"></span>
                            </p>
                            <div class="sold-box">
                                <span class="product-total-sold"></span><span class="ml-1">Sold</span>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>
</div>


<script>
    var allProductList = [];
    var allFilteredProductList = [];
    var isSearch = @Model.IsSearch;
    var currentPage = 0;
    var isLoading = false;
    var scrollPosition = 0;
    var scrollDirection;
    var noMoreItems = false;
    var itemsToShowPerLoad = 30;
    var rand = 0;

    function genTemplateRating(template, item) {
        var itemRating = item.rating;
        if (itemRating == 0) {
            if (item.id == 0) {
                template.find('.rating-box').hide();
            } else {
                itemRating = 5.0;
                template.find(".product-rating").html("5.0");
            }
        } else {
            var rating = Math.round(itemRating);
            for (let i = 0; i < rating; i++) {
                template.find('.rating-box .fa-star').eq(i).removeClass('fa-regular').addClass('fas');
            }
            var decimal = itemRating - rating;
            if (decimal > 0.25) {
                template.find('.rating-box .fa-star').eq(rating).attr('class', '').addClass('fas').addClass('fa-star-half').addClass('checked');
            } else if (decimal < -0.25) {
                template.find('.rating-box .fa-star').eq(rating - 1).attr('class', '').addClass('fas').addClass('fa-star-half').addClass('checked');
            }
            template.find('.product-rating').text(itemRating.toFixed(1));
        }
    }


    function addVPointDiscount(template, item) {
        var VPointDiscountRate = 0;

        if (item.discountedPrice < 50) {
            VPointDiscountRate = 0.12;
        } else if (item.discountedPrice < 100) {
            VPointDiscountRate = 0.08;
        } else if (item.discountedPrice < 200) {
            VPointDiscountRate = 0.06;
        } else if (item.discountedPrice < 300) {
            VPointDiscountRate = 0.04;
        } else if (item.discountedPrice < 400) {
            VPointDiscountRate = 0.03;
        }

        var newItemdiscountPrice = item.discountedPrice * (1 - VPointDiscountRate);
        if (item.price > 0) {
            var originalPrice = item.price
        } else {
            var originalPrice = item.discountedPrice
        }
        var newItemdiscountRate = (100 * (originalPrice - newItemdiscountPrice) / originalPrice).toFixed(0);

        if (newItemdiscountRate == 0) {
            template.find('.product-price').html("RM" + newItemdiscountPrice.toFixed(2));
        }
        else {
            template.find('.product-price').html("<del>RM" + originalPrice.toFixed(2) + "</del> RM" + newItemdiscountPrice.toFixed(2));
            template.find('.badge').html(newItemdiscountRate + " % OFF");
            template.find('.product-discount').show();
        }
    }

    function onPriceFilterApply() {
          var price =
          {
              minPrice: $("#priceMin").val(),
              maxPrice: $("#priceMax").val(),
          }
          var searchText = $(".product-search-input").val().toLowerCase();
          var isCategory = false;
          if ($(".subcategoryfilter.selected").length > 0) {
              isCategory = true;
          }
          var productTypeId = $(".selectedProductType.active").attr("data-type-id");
          
          var subcategoryFilterList = Array();
          $(".subcategoryfilter").each(function () {
              if ($(this).hasClass("selected")) {
                  subcategoryFilterList.push($(this).attr("data-id"));
              }
          });
          currentPage = 0;
          var locationFilterList = Array();
          $(".locationFilter").each(function() {
              if ($(this).hasClass("selected")) {
                  locationFilterList.push($(this).attr("data-id"));
              }
          });

          GetProductBySubcategoryListAndPrice(subcategoryFilterList, price, true, productTypeId, searchText, isCategory, locationFilterList);
      };


    $(document).ready(function () {
        $("#btnMenu").hide();
        $("#btnFilter").css("display", "flex");

        GetProvinceList(1);
        $(".selectedProductType").click(function () {
                window.location.replace(window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1)+ "search?keyword=" + $(this).attr('data-type-name').replace(" ", "%20"))
            //window.location.replace(window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1) + $(this).attr('data-type-name').replace(" ", "-")/* + "?location=" + $("#provinceSelect option:selected").text().replace(" ", "-")*/);
            $(".selectedProductType").removeClass('active');
            $(this).addClass('active');
            $(".fa-shopping-cart").focus();
            $(this).blur();
            $(".category-title").html($(this).find("span").html().replace("<br>", "")); //+ " items available in " + $("#provinceSelect option:selected").text());
            currentPage = 0;
            clearList = true;
            if ($(this).attr('data-type-id') != 0) {
                GetProductSubcategoryList($(this).attr('data-type-id'));
                getProductListByType($(this).attr('data-type-id'));
            }
            else {
                $("#productSubategoryFilter").html("");

                GetProductList();
            }
            var productTypeId = $(this).attr('data-type-id');

            if (productTypeId == 0) {
                allFilteredProductList = allProductList;
            }
            else {
                allFilteredProductList = allProductList.filter(function (product) {
                    return product.productCategoryId == productTypeId;
                });
            }
        });
        if (@Model.IsSearch) {
            $("#provinceSelect").val(vodusUser_config.getUserProvince());
            $(".category-title").html("Search result for '" + "@Model.SearchText" + "'");

        }
        else {
            $("#provinceSelect").val(@Model.ProvinceId);
        }

        vodusUser_config.addToUser_config($("#provinceSelect").val());

        if (@Model.IsSearch) {

        }
        else {
            $(".selectedProductType").each(function () {
                if (parseInt($(this).attr('data-type-id')) == @Model.CategoryId) {
                   $(this).trigger('click');
                }
            });
        }
        $(".product-search-input").val($("<div>", {html:"@Model.SearchText"}).text());

        $("#provinceSelect").on("change", function () {
            vodusUser_config.addToUser_config($("#provinceSelect").val());
            document.location = "/"
        });

        $(window).scroll(function () {
            if (noMoreItems) {
                return;
            }
            scrollDirection = (document.body.getBoundingClientRect()).top > scrollPosition ? 'up' : 'down';
            scrollPosition = (document.body.getBoundingClientRect()).top;
            if ($(window).scrollTop() + $(window).height() >= $("#productList").height() - 250) {
                if (scrollDirection == "down") {
                    $("#btnLoadMore").click();
                }
            }
        });

        $("#btnLoadMore").on("click", function () {
            var counter = 0;
            var itemAdded = 0;
            var currenlyDislayedItem = $(".listItem").length;

            if (parseInt($('#productList').children().last().attr("product-id")) != 0) {
                $.each(allProductList, function (i, item) {
                    if (item.id == parseInt($('#productList').children().last().attr("product-id"))) {
                        currenlyDislayedItem = i + 1;
                    }
                });
            }
            else if (parseInt($('#productList').children().last().attr("product-id")) == 0) {
                $.each(allProductList, function (i, item) {
                    if (item.externalUrl == $('#productList').children().last().attr("product-external-url")) {
                        currenlyDislayedItem = i + 1;
                    }
                });
            }
            $.each(allProductList.slice(currenlyDislayedItem), function (i, item) {
                counter++;
                if (counter > itemsToShowPerLoad) {
                    return;
                }
                if (counter <= itemsToShowPerLoad) {
                    itemAdded++;
                    var url = "/product/" + item.id;
                    if (item.externalItemId != null && item.externalItemId != "") {
                        url += "?i=" + item.externalItemId + "&s=" + item.externalShopId + "&t=" + item.externalTypeId;
                    }
                    var template = $("#productTemplate").children().clone();
                    template.attr("product-id", item.id);
                    template.attr("product-url", url);
                    template.attr("product-external-url", item.externalUrl);
                    template.find('.product-img').attr('data-src', item.productImage).addClass("lazyload");
                    template.find('.outlet-location').text(item.outletLocation);

                    genTemplateRating(template, item);

                    if (item.totalSold == 0) {
                        template.find('.sold-box').hide();
                    } else {
                        template.find('.product-total-sold').text(numberWithCommas(item.totalSold));
                    }

                            if (item.externalItemId != null && item.externalItemId != "") {
                                addVPointDiscount(template, item);
                            } else {
                                if (item.dealTypeId == 1)
                                    template.find('.product-price').html(item.pointsRequired + " VPoints");
                                else if (item.dealTypeId == 2) {
                                    if (item.discountRate == 0) {
                                        template.find('.product-price').html("RM" + item.discountedPrice.toFixed(2));
                                    }
                                    else {
                                        template.find('.product-price').html("<del>RM" + item.price.toFixed(2) + "</del> RM" + item.discountedPrice.toFixed(2));
                                        template.find('.badge').html(item.discountRate + " % OFF");
                                        template.find('.product-discount').show();
                                    }
                                }
                            }

                            template.find('.product-name').html(item.title);
                            template.find('.product-link').attr('href', url);
                            //template.find('.product-description').html(item.description);
                            template.find('.product-type-name').html(item.productSubCategory);
                            template.find('.merchant-name').html(item.merchantName);
                            template.find('.addtocart-btn').attr('data-id', item.id);
                            template.find('.addtocart-btn').attr('data-summary', item.ProductSummary);
                            template.find('.addtocart-btn').attr('data-points', item.PointsRequired);
                            template.find('.addtocart-btn').attr('data-name', item.Name);
                            template.find('.addtocart-btn').attr('data-thumbnail-photo', item.ProductThumbnailImageUrl);
                            template.find('.addtocart-btn').attr('data-type-name', item.ProductTypeName);
                            template.find('.addtocart-btn').attr('data-type', item.ProductType);
                            $('#productList').append(template);
                            counter++;
                        }

                });
                if (counter < itemsToShowPerLoad) {

                    if (itemAdded == 0 && !isLoading) {
                        var isCategory = false;
                        if ($(".subcategoryfilter.selected").length > 0) {
                            isCategory = true;
                        }
                        var searchText = $(".product-search-input").val().toLowerCase();
                        var isPrice = true;
                        var filterList = Array();
                        var productTypeId = $(".selectedProductType.active").attr("data-type-id");
                        $(".priceFilter").each(function () {
                            if ($(this).hasClass("selected")) {
                                filterList.push($(this).attr("data-id"));
                            }
                        });
                        /*$(".pointsFilter").each(function () {
                            if ($(this).prop("checked")) {
                                isPrice = false;
                                filterList.push($(this).attr("data-id"));
                            }
                        });*/

                        var subcategoryFilterList = Array();
                        $(".subcategoryfilter").each(function () {
                            if ($(this).hasClass("selected")) {
                                subcategoryFilterList.push($(this).attr("data-id"));
                            }
                        });
                        var locationFilterList = Array();
                        $(".locationFilter").each(function () {
                            if ($(this).hasClass("selected")) {
                                locationFilterList.push($(this).attr("data-id"));
                            }
                        });

                        GetProductBySubcategoryListAndPrice(subcategoryFilterList, filterList, isPrice, productTypeId, searchText, isCategory, locationFilterList);
                    }
                    //$("#btnLoadMore").css("display", "none");
                    //$("#btnNoMore").css("display", "inline-block");
                }
                ResizeBasedOnMaxContentElement();
                $(".addtocart-btn").unbind().click(function () {
                    location.href = "/product/" + $(this).attr('data-id');
                });

            });


         function GetProductList() {
            $.ajax({
                type: "GET",
                dataType: 'json',
                data: { provinceId:  $("#provinceSelect").val() },
                url: '@Url.Action("GetProductList", "Home")',
                success: function (response) {
                    if (response.successful) {
                        if (response.data != null) {
                            if (response.data.length > 0) {

                                // for our Deals
                                var counter = 0;
                                $("#productList").html("");
                                $.each(response.data, function (i, item) {

                                    allFilteredProductList = response.data;
                                    if (counter < itemsToShowPerLoad) {
                                        var productlist = "";
                                        var url = "/product/" + item.id;
                                        if (item.externalItemId != null && item.externalItemId != "") {
                                            url += "?i=" + item.externalItemId + "&s=" + item.externalShopId + "&t=" + item.externalTypeId;
                                        }
                                        var template = $("#productTemplate").children().clone();

                                        genTemplateRating(template, item);

                                        if (item.totalSold == 0) {
                                            template.find('.sold-box').hide();
                                        } else {
                                            template.find('.product-total-sold').text(numberWithCommas(item.totalSold));
                                        }

                                        template.find('.outlet-location').text(item.outletLocation);

                                        template.attr("product-id", item.id);
                                        template.attr("product-url", url);
                                        template.attr("product-external-url", item.externalUrl);
                                        template.find('.product-img').attr('data-src', item.productImage).addClass("lazyload");

                                        if (item.externalItemId != null && item.externalItemId != "") {
                                            addVPointDiscount(template, item);
                                        } else {
                                            if (item.dealTypeId == 1)
                                                template.find('.product-price').html(item.pointsRequired + " VPoints");
                                            else if (item.dealTypeId == 2) {
                                                if (item.discountRate == 0) {
                                                    template.find('.product-price').html("RM" + item.discountedPrice.toFixed(2));
                                                }
                                                else {
                                                    template.find('.product-price').html("<del>RM" + item.price.toFixed(2) + "</del> RM" + item.discountedPrice.toFixed(2));
                                                    template.find('.badge').html(item.discountRate + " % OFF");
                                                    template.find('.product-discount').show();
                                                }
                                            }
                                        }

                                        template.find('.product-name').html(item.title);
                                        template.find('.product-link').attr('href', url);
                                        template.find('.product-type-name').html(item.productSubCategory);
                                        template.find('.merchant-name').html(item.merchantName);
                                        //if (item.ProductType == 2) {
                                        //    template.find('.product-description').html("Draw date: " + moment(item.LuckyDrawDate).format('DD-MM-YYYY') + "<br/>" + "Tickets issued: " + item.LuckyDrawTicketIssued);
                                        //}
                                        //else {
                                        //    template.find('.product-description').html(item.ProductSummary);
                                        //}

                                        //template.find('.viewDetail').attr('href', newUrl);
                                        template.find('.addtocart-btn').attr('data-id', item.id);
                                        template.find('.addtocart-btn').attr('data-summary', item.ProductSummary);
                                        template.find('.addtocart-btn').attr('data-points', item.PointsRequired);
                                        template.find('.addtocart-btn').attr('data-name', item.Name);
                                        template.find('.addtocart-btn').attr('data-thumbnail-photo', item.ProductThumbnailImageUrl);
                                        template.find('.addtocart-btn').attr('data-type-name', item.ProductTypeName);
                                        template.find('.addtocart-btn').attr('data-type', item.ProductType);
                                        //template.find('.addtocart-btn').attr('href', url);
                                        $('#productList').append(template);
                                        counter++;
                                    }
                                });
                                ResizeBasedOnMaxContentElement();
                                $(".addtocart-btn").click(function () {
                                    location.href = "/product/" + $(this).attr('data-id');
                                });

                                if (counter < itemsToShowPerLoad) {
                                    $("#btnLoadMore").css("display", "none");
                                    $("#btnNoMore").css("display", "inline-block");
                                } else {
                                    $("#btnLoadMore").css("display", "inline-block");
                                    $("#btnNoMore").css("display", "none");
                                }
                                $('#loadingMessage').hide();
                            }
                        }
                        else {
                            $('#loadingMessage').html('<h3 class="no-products">No products found</h3>');
                            $("#btnLoadMore").css("display", "none");
                        }
                    } else {

                        toastr.error(response.message);
                    }
                    $('#loadingMessage').hide();
                },
                error: function (error) {
                    toastr.error(error);
                    $('#loadingMessage').hide();
                }
            });
     }

        $(".locationFilter").click(function () {
            if ($(this).hasClass("selected")) {
                $(this).removeClass("selected");
            } else {
                $(this).addClass("selected");
            }

            if ($(this).attr("data-id") == 19 && $(this).hasClass("selected")) {
                $(".locationFilter").removeClass("selected");
                $(this).addClass("selected");
            }
            else if ($(this).hasClass("selected")) {
                $("#location-cat-2").removeClass("selected");
            }
        });


        $(".product-search-btn").unbind().click(function () {
            var isCategory = false;
            if ($(".subcategoryfilter.selected").length > 0) {
                isCategory = true;
            }
            var searchText = $(".product-search-input").val().toLowerCase();
            var isPrice = true;
            var filterList = Array();
            var productTypeId = $(".selectedProductType.active").attr("data-type-id");

            var productTypeId = $(".selectedProductType.active").attr("data-type-id");
            var price =
            {
                minPrice: $("#priceMin").val(),
                maxPrice: $("#priceMax").val(),
            }

            var subcategoryFilterList = Array();
            $(".subcategoryfilter").each(function () {
                if ($(this).hasClass("selected")) {
                    subcategoryFilterList.push($(this).attr("data-id"));
                }
            });
            var locationFilterList = Array();
            $(".locationFilter").each(function () {
                if ($(this).hasClass("selected")) {
                    locationFilterList.push($(this).attr("data-id"));
                }
            });
            currentPage = 0;
            GetProductBySubcategoryListAndPrice(subcategoryFilterList, price, isPrice, productTypeId, searchText, isCategory, locationFilterList);

        });

        $('.product-search-input').on('search', function () {
            var isCategory = false;
            if ($(".subcategoryfilter.selected").length > 0) {
                isCategory = true;
            }
            var searchText = $(".product-search-input").val().toLowerCase();
            var isPrice = true;
 
            var productTypeId = $(".selectedProductType.active").attr("data-type-id");
            var price =
            {
                minPrice: $("#priceMin").val(),
                maxPrice: $("#priceMax").val(),
            }

            var subcategoryFilterList = Array();
            $(".subcategoryfilter").each(function () {
                if ($(this).hasClass("selected")) {
                    subcategoryFilterList.push($(this).attr("data-id"));
                }
            });
            var locationFilterList = Array();
            $(".locationFilter").each(function () {
                if ($(this).hasClass("selected")) {
                    locationFilterList.push($(this).attr("data-id"));
                }
            });
            currentPage = 0;
            GetProductBySubcategoryListAndPrice(subcategoryFilterList, price, isPrice, productTypeId, searchText, isCategory, locationFilterList);
        });
        $(".product-search-btn").click();

        $(".subcategoryfilter").change(function () {
            var searchText = $(".product-search-input").val().toLowerCase();
            var isPrice = true;
            var productTypeId = $(".selectedProductType.active").attr("data-type-id")
            var price =
            {
                minPrice: $("#priceMin").val(),
                maxPrice: $("#priceMax").val(),
            }

            var subcategoryFilterList = Array();
            $(".subcategoryfilter").each(function () {
                if ($(this).hasClass("selected")) {
                    subcategoryFilterList.push($(this).attr("data-id"));
                }
            });
            var locationFilterList = Array();
            $(".locationFilter").each(function () {
                if ($(this).hasClass("selected")) {
                    locationFilterList.push($(this).attr("data-id"));
                }
            });
            currentPage = 0;
            GetProductBySubcategoryListAndPrice(subcategoryFilterList, price, isPrice, productTypeId, searchText, true, locationFilterList);
        });

        $(".hot-categories-title i").click(function () {
            $(this).toggleClass("fa-angle-down").toggleClass("fa-angle-right");
        });

       /* if ($(window).width() < 975) {
            $(".hot-categories-title i").click();
        }*/

        if ($('#productList').length == 1) {
            $('#loadingMessage').html('<h3 class="no-products" style="font-size: 20px; margin-top: 25px; color: #999;">Loading...</h3>')
            $('#btnLoadMore').hide();
        }
    });

    function GetFiltersForQueryingProductsList() {

        var isCategory = false;
        if ($(".subcategoryfilter.selected").length > 0) {
            isCategory = true;
        }
        if ($(".product-search-input").val() != undefined)
            var searchText = $(".product-search-input").val().toLowerCase();
        else
            var searchText = $(".product-search-input").val()

        var isPrice = true;

        var productTypeId = $(".selectedProductType.active").attr("data-type-id");

         var price =
            {
                minPrice: $("#priceMin").val(),
                maxPrice: $("#priceMax").val(),
            }

        var subcategoryFilterList = Array();
        $(".subcategoryfilter").each(function () {
            if ($(this).hasClass("selected")) {
                subcategoryFilterList.push($(this).attr("data-id"));
            }
        });

        var locationFilterList = Array();
        $(".locationFilter").each(function () {
            if ($(this).hasClass("selected")) {
                locationFilterList.push($(this).attr("data-id"));
            }
        });
        console.log(locationFilterList);
        GetProductBySubcategoryListAndPrice(subcategoryFilterList, price, isPrice, productTypeId, searchText, isCategory, locationFilterList);
    }

        $("#orderSorting").change(function () {
            $(".selectedProductType").each(function () {
                if ($(this).hasClass('active')) {
                    currentPage = 0;
                    clearList = true;
                    getProductListByType($(this).attr('data-type-id'));
                }
            });
        });

    function getProductListByType(type) {

        var sortBy = $("#orderSorting").val();
        $(".orderSorting").each(function () {
            if ($(this).hasClass('active')) {
                sortBy = $(this).attr('data-sort-by');
            }
        });

        $.ajax({
            type: 'GET',
            data: { type: type, provinceId: $("#provinceSelect").val(), page: currentPage },
            url: '@Url.Action("GetProductByType", "Home")',
            success: function (response) {
                if (response.successful) {
                    if (response.data.length > 0) {

                        allProductList = response.data;
                        var counter = 0;
                        $("#productList").html("");
                        $.each(response.data, function (i, item) {
                            allFilteredProductList = response.data;
                            if (counter < itemsToShowPerLoad) {
                                var productlist = "";
                                var url = "/product/" + item.id;
                                if (item.externalItemId != null && item.externalItemId != "") {
                                    url += "?i=" + item.externalItemId + "&s=" + item.externalShopId + "&t=" + item.externalTypeId;
                                }
                                var template = $("#productTemplate").children().clone();

                                genTemplateRating(template, item);

                                if (item.totalSold == 0) {
                                    template.find('.sold-box').hide();
                                } else {
                                    template.find('.product-total-sold').text(numberWithCommas(item.totalSold));
                                }

                                template.find('.outlet-location').text(item.outletLocation);

                                template.attr("product-url", url);

                                template.attr("product-id", item.id);
                                template.attr("product-url", url);
                                template.attr("product-external-url", item.externalUrl);
                                template.find('.product-img').attr('data-src', item.productImage).addClass("lazyload");

                                if (item.externalItemId != null && item.externalItemId != "") {
                                    addVPointDiscount(template, item);
                                } else {
                                    if (item.dealTypeId == 1)
                                        template.find('.product-price').html(item.pointsRequired + " VPoints");
                                    else if (item.dealTypeId == 2) {
                                        if (item.discountRate == 0) {
                                            template.find('.product-price').html("RM" + item.discountedPrice.toFixed(2));
                                        }
                                        else {
                                            template.find('.product-price').html("<del>RM" + item.price.toFixed(2) + "</del> RM" + item.discountedPrice.toFixed(2));
                                            template.find('.badge').html(item.discountRate + " % OFF");
                                            template.find('.product-discount').show();
                                        }
                                    }
                                }

                                template.find('.product-name').html(item.title);
                                template.find('.product-link').attr('href', url);
                                template.find('.product-type-name').html(item.productSubCategory);
                                template.find('.merchant-name').html(item.merchantName);
                                //if (item.ProductType == 2) {
                                //    template.find('.product-description').html("Draw date: " + moment(item.LuckyDrawDate).format('DD-MM-YYYY') + "<br/>" + "Tickets issued: " + item.LuckyDrawTicketIssued);
                                //}
                                //else {
                                //    template.find('.product-description').html(item.ProductSummary);
                                //}

                                //template.find('.viewDetail').attr('href', newUrl);
                                template.find('.addtocart-btn').attr('data-id', item.id);
                                template.find('.addtocart-btn').attr('data-summary', item.ProductSummary);
                                template.find('.addtocart-btn').attr('data-points', item.PointsRequired);
                                template.find('.addtocart-btn').attr('data-name', item.Name);
                                template.find('.addtocart-btn').attr('data-thumbnail-photo', item.ProductThumbnailImageUrl);
                                template.find('.addtocart-btn').attr('data-type-name', item.ProductTypeName);
                                template.find('.addtocart-btn').attr('data-type', item.ProductType);
                                //template.find('.addtocart-btn').attr('href', url);
                                $('#productList').append(template);
                                counter++;
                            }
                        });
                        ResizeBasedOnMaxContentElement();
                        $(".addtocart-btn").click(function () {
                            location.href = "/product/" + $(this).attr('data-id');
                        });
                        console.log("counter = " + counter);
                        if (counter < itemsToShowPerLoad) {
                            $("#btnLoadMore").css("display", "none");
                            $("#btnNoMore").css("display", "inline-block");
                        } else {
                            $("#btnLoadMore").css("display", "inline-block");
                            $("#btnNoMore").css("display", "none");
                        }
                    } else {
                        $('#productList').html('<h3 class="no-products">No products found</h3>')
                        $("#btnLoadMore").css("display", "none");
                    }
                }
                else {
                    toastr.error(response.message);
                }
            },
            error: function () {
                $("#loaderContainer").hide();
            }
        });
    }

    function ResizeBasedOnMaxContentElement() {
        if ($("#productList").find(".ibox").length < 4) {
            $("#productList").css("justify-content", "flex-start")
        };
    }


    function GetProductSubcategoryList(categoryId) {
        if (categoryId == 12) {
            $(".subCategory-filter").hide();
            return;
        }
        $(".subCategory-filter").show();
        $.ajax({
            type: "GET",
            dataType: 'json',
            async: false,
            data: { categoryId: categoryId },
            url: '@Url.Action("GetProductSubcategoryList", "Home")',
            success: function (response) {
                if (response.successful) {
                    if (response.data != null) {
                        var categoryList = "";
                        $.each(response.data, function (i, item) {
                            categoryList = categoryList + "<div class='custom-control custom-checkbox'>" +
                                "<input type='checkbox' class='subcategoryfilter custom-control-input' id='cat-" + item.id + "' data-id='" + item.id + "'>" +
                                "<label class='custom-control-label' for='cat-" + item.id + "'>" + item.name + "</label></div>";
                        });
                        $("#productSubategoryFilter").html(categoryList);
                        $(".subcategoryfilter").change(function () {
                            var subcategoryFilterList = Array();
                            $(".subcategoryfilter").each(function () {
                                if ($(this).hasClass("selected")) {
                                    subcategoryFilterList.push($(this).attr("data-id"));
                                }
                            });
                            var isCategory = false;
                            if ($(".subcategoryfilter.selected").length > 0) {
                                isCategory = true;
                            }
                            var searchText = $(".product-search-input").val().toLowerCase();
                            var isPriceFilter = true;
                            var filterList = Array();
                            var productTypeId = $(".selectedProductType.active").attr("data-type-id");
                            //if ($(".selectedProductType.active").attr("data-type-id") == 12) {
                            var locationFilterList = Array();
                            $(".locationFilter").each(function () {
                                if ($(this).hasClass("selected")) {
                                    locationFilterList.push($(this).attr("data-id"));
                                }
                            });
                            currentPage = 0;
                            GetProductBySubcategoryListAndPrice(subcategoryFilterList, filterList, isPriceFilter, productTypeId, searchText, isCategory, locationFilterList);
                        });
                    }
                } else
                    toastr.error(response.message);
            },
            error: function (error) {
                toastr.error(error);
            }
        });
        if ($("#productSubategoryFilter").html().trim() == "") {
            $(".subCategory-filter").hide()
        }
    }
    function GetProductBySubcategoryList(type) {
        var sortBy = $("#orderSorting").val();
        $(".orderSorting").each(function () {
            if ($(this).hasClass('active')) {
                sortBy = $(this).attr('data-sort-by');
            }
        });

        if (type.length == 0) {
            getProductListByType($(".selectedProductType.active").attr("data-type-id"))
            return false;
        }
        $('#loadingMessage').show();
        $.ajax({
            type: 'GET',
            dataType: "json",
            contentType: 'application/json',
            data: { filter: JSON.stringify(type) },
            url: '@Url.Action("GetProductBySubcategoryList", "Home")',
            success: function (response) {

                if (response.successful) {
                    if (response.data.length > 0) {
                        allProductList = response.data;

                        var counter = 0;
                        $("#productList").html("");
                        $.each(response.data, function (i, item) {
                            allFilteredProductList = response.data;
                            if (counter < itemsToShowPerLoad) {
                                var productlist = "";
                                var url = "/product/" + item.id;
                                if (item.externalItemId != null && item.externalItemId != "") {
                                    url += "?i=" + item.externalItemId + "&s=" + item.externalShopId + "&t=" + item.externalTypeId;
                                }
                                var template = $("#productTemplate").children().clone();
                                template.attr("product-id", item.id);
                                template.attr("product-url", url);
                                template.attr("product-external-url", item.externalUrl);
                                template.find('.product-img').attr('data-src', item.productImage).addClass("lazyload");

                                genTemplateRating(template, item);

                                if (item.totalSold == 0) {
                                    template.find('.sold-box').hide();
                                } else {
                                    template.find('.product-total-sold').text(numberWithCommas(item.totalSold));
                                }

                                template.find('.outlet-location').text(item.outletLocation);

                                if (item.externalItemId != null && item.externalItemId != "") {
                                    addVPointDiscount(template, item);
                                } else {
                                    if (item.dealTypeId == 1)
                                        template.find('.product-price').html(item.pointsRequired + " VPoints");
                                    else if (item.dealTypeId == 2) {
                                        if (item.discountRate == 0) {
                                            template.find('.product-price').html("RM" + item.discountedPrice.toFixed(2));
                                        }
                                        else {
                                            template.find('.product-price').html("<del>RM" + item.price.toFixed(2) + "</del> RM" + item.discountedPrice.toFixed(2));
                                            template.find('.badge').html(item.discountRate + " % OFF");
                                            template.find('.product-discount').show();
                                        }
                                    }
                                }

                                template.find('.product-name').html(item.title);
                                template.find('.product-link').attr('href', url);
                                template.find('.product-type-name').html(item.productSubCategory);
                                template.find('.merchant-name').html(item.merchantName);
                                //template.find('.product-description').html(item.description);
                                //if (item.ProductType == 2) {
                                //    template.find('.product-description').html("Draw date: " + moment(item.LuckyDrawDate).format('DD-MM-YYYY') + "<br/>" + "Tickets issued: " + item.LuckyDrawTicketIssued);
                                //}
                                //else {
                                //    template.find('.product-description').html(item.ProductSummary);
                                //}

                                //template.find('.viewDetail').attr('href', newUrl);
                                template.find('.addtocart-btn').attr('data-id', item.id);
                                template.find('.addtocart-btn').attr('data-summary', item.ProductSummary);
                                template.find('.addtocart-btn').attr('data-points', item.PointsRequired);
                                template.find('.addtocart-btn').attr('data-name', item.Name);
                                template.find('.addtocart-btn').attr('data-thumbnail-photo', item.ProductThumbnailImageUrl);
                                template.find('.addtocart-btn').attr('data-type-name', item.ProductTypeName);
                                template.find('.addtocart-btn').attr('data-type', item.ProductType);
                                //template.find('.addtocart-btn').attr('href', url);
                                $('#productList').append(template);
                                counter++;
                            }
                        });
                        ResizeBasedOnMaxContentElement();
                        $(".addtocart-btn").click(function () {
                            location.href = "/product/" + $(this).attr('data-id');
                        });
                        if (counter < itemsToShowPerLoad) {
                            $("#btnLoadMore").css("display", "none");
                            $("#btnNoMore").css("display", "inline-block");
                        } else {
                            $("#btnLoadMore").css("display", "inline-block");
                            $("#btnNoMore").css("display", "none");
                        }
                    } else {
                            $("#displayNoItems").show();
                        if (currentPage == 1) {

                            $("#noProduct").css("display", "block");
                        }
                        else {
                        }
                    }
                }
                else {
                    toastr.error(response.message);
                }
                $('#loadingMessage').hide();
            },
            error: function () {
                $("#loaderContainer").hide();
                $('#loadingMessage').hide();
            }
        });
    }

    function GetProductBySubcategoryListAndPrice(CategoryFilter, priceFilter, isPriceFilter, productTypeId, searchText, IsCategory, locationFilter) {
            if (isLoading) {
                return;
            }
            currentPage++;
            isLoading = true;
            var sortBy = $("#orderSorting").val();
            $(".orderSorting").each(function () {
                if ($(this).hasClass('active')) {
                    sortBy = $(this).attr('data-sort-by');
                }
            });

            //if (CategoryFilter.length == 0 && priceFilter.length == 0 && (searchText == undefined || searchText == "")) {
            //    getProductListByType($(".selectedProductType.active").attr("data-type-id"))
            //    return false;
            //}
            if (searchText == undefined) {
                searchText = "";
            }

            $("#btnLoadMore").hide();
            $('#loadingMessage').show();

            $.ajax({
                global: false,
                type: 'GET',
                dataType: "json",
                contentType: 'application/json',
                data: { subCatergoryFilter: JSON.stringify(CategoryFilter), priceMin : priceFilter.minPrice,priceMax : priceFilter.maxPrice, IsPriceFilter: isPriceFilter, productTypeId: productTypeId, locationFilter: JSON.stringify(locationFilter), searchText: searchText, isCategory: IsCategory, page: currentPage },
                url: '@Url.Action("GetProductBySubcategoryListAndPrice", "Home")',
                success: function (response) {
                    isLoading = false;
                    if (response.successful) {
                        if (response.data != null) {
                            if (response.data.length > 0) {
                                rand = response.data[0].rand
                                allProductList = response.data;
                                if (allProductList < itemsToShowPerLoad) {
                                    noMoreItems = true;
                                }
                                if (currentPage == 1) {
                                    $("#productList").html("");
                                }
                                var counter = 0;
                                //$("#productList").html("");
                                $.each(response.data, function (i, item) {
                                    allFilteredProductList = response.data;
                                    if (counter < itemsToShowPerLoad) {
                                        var productlist = "";
                                        var url = "/product/" + item.id;
                                        if (item.externalItemId != null && item.externalItemId != "") {
                                            url += "?i=" + item.externalItemId + "&s=" + item.externalShopId + "&t=" + item.externalTypeId;
                                        }
                                        var template = $("#productTemplate").children().clone();
                                        template.attr("product-id", item.id);
                                        template.attr("product-url", url);
                                        template.attr("product-external-url", item.externalUrl);
                                        template.find('.product-img').attr('data-src', item.productImage).addClass("lazyload");

                                        genTemplateRating(template, item);

                                        if (item.totalSold == 0) {
                                            template.find('.sold-box').hide();
                                        } else {
                                            template.find('.product-total-sold').text(numberWithCommas(item.totalSold));
                                        }

                                        template.find('.outlet-location').text(item.outletLocation);

                                        if (item.externalItemId != null && item.externalItemId != "") {
                                            addVPointDiscount(template, item);
                                        } else {
                                            if (item.dealTypeId == 1)
                                                template.find('.product-price').html(item.pointsRequired + " VPoints");
                                            else if (item.dealTypeId == 2) {
                                                if (item.discountRate == 0) {
                                                    template.find('.product-price').html("RM" + item.discountedPrice.toFixed(2));
                                                }
                                                else {
                                                    template.find('.product-price').html("<del>RM" + item.price.toFixed(2) + "</del> RM" + item.discountedPrice.toFixed(2));
                                                    template.find('.badge').html(item.discountRate + " % OFF");


                                                    template.find('.product-discount').show();
                                                }
                                            }
                                        }

                                        template.find('.product-name').html(item.title);
                                        template.find('.product-link').attr('href', url);
                                        template.find('.product-type-name').html(item.productSubCategory);
                                        template.find('.merchant-name').html(item.merchantName);
                                        template.find('.addtocart-btn').attr('data-id', item.id);
                                        template.find('.addtocart-btn').attr('data-summary', item.ProductSummary);
                                        template.find('.addtocart-btn').attr('data-points', item.PointsRequired);
                                        template.find('.addtocart-btn').attr('data-name', item.Name);
                                        template.find('.addtocart-btn').attr('data-thumbnail-photo', item.ProductThumbnailImageUrl);
                                        template.find('.addtocart-btn').attr('data-type-name', item.ProductTypeName);
                                        template.find('.addtocart-btn').attr('data-type', item.ProductType);
                                        $('#productList').append(template);
                                        counter++;
                                    }
                                });
                                ResizeBasedOnMaxContentElement();
                                $(".addtocart-btn").click(function () {
                                    location.href = "/product/" + $(this).attr('data-id');
                                });
                                $('#loadingMessage').hide();
                                if (counter < itemsToShowPerLoad) {

                                    $("#btnLoadMore").css("display", "none");
                                    $("#btnNoMore").css("display", "inline-block");

                                } else {
                                    $("#btnLoadMore").css("display", "inline-block");
                                    $("#btnNoMore").css("display", "none");
                                }

                                $(".product-filter .close-btn-img").click();
                            } else {
                                $('#loadingMessage').hide();
                                $('#productList').html('<h3 class="no-products">No products found</h3>')
                                $("#btnLoadMore").css("display", "none");
                                $("#btnNoMore").css("display", "inline-block");
                                if (allProductList.length < 60) {
                                    noMoreItems = true;
                                }
                            }

                        }
                        else {
                            noMoreItems = true;
                            $("#btnLoadMore").css("display", "none");
                            $("#btnNoMore").css("display", "inline-block");
                            if (currentPage == 1) {
                                $("#productList").html("");
                            }
                        }
                    }
                    else {
                        toastr.error(response.message);
                    }
                    $('#loadingMessage').hide();
                },
                error: function () {
                    isLoading = false;
                    $("#loaderContainer").hide();
                }
            });
        if ($("#productSubategoryFilter").html().trim() == "") {
            $(".subCategory-filter").hide()
        }
    }

</script>
